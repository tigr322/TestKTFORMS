<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Отчёты KTFOMS</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
  <style>
    body { padding: 20px; }
    .form-inline .form-group { margin-right: 8px; }
  </style>
</head>
<body class="container">
  <h2>1) МО - Месяц - Год - Сумма</h2>
  <table id="tbl1" class="table table-striped table-bordered" width="100%"></table>

  <hr>
  <h2>2) МО - Тип оплаты - Счета - Сумма</h2>
  <div class="form-inline">
    <div class="form-group">
      <label>Год</label>
      <input id="y2" class="form-control" style="width:100px" value="2018">
    </div>
    <div class="form-group">
      <label>Месяц</label>
      <input id="m2" class="form-control" style="width:80px" value="1">
    </div>
    <button id="load2" class="btn btn-primary">Загрузить</button>
  </div>
  <table id="tbl2" class="table table-striped table-bordered" width="100%"></table>

  <hr>
  <h2>3) Вид помощи - Посещения - Обращения - Счета - Сумма</h2>
  <div class="form-inline">
    <div class="form-group">
      <label>Год</label>
      <input id="y3" class="form-control" style="width:100px" value="2018">
    </div>
    <div class="form-group">
      <label>Месяц</label>
      <input id="m3" class="form-control" style="width:80px" value="1">
    </div>
    <button id="load3" class="btn btn-primary">Загрузить</button>
  </div>
  <table id="tbl3" class="table table-striped table-bordered" width="100%"></table>

  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

  <script>

var dt1 = $('#tbl1').DataTable({
      ajax: {
        url: '/api/report.php',
        data: function (d) { d.type = 'lpu_month_sum'; },
        dataSrc: function (json) {
        
          return (json.data || []).map(function (r) {
            return {
              mo_code: r['МЕД. ОРГАНИЗАЦИЯ (КОД)'] || r['МО (КОД)'] || r['MO_CODE'] || '',
              mo_name: r['МЕД. ОРГАНИЗАЦИЯ (НАИМЕНОВАНИЕ)'] ||
                      r['МО (НАИМЕНОВАНИЕ)'] || r['МО (НАИМЕН.)'] || r['MO_NAME'] || '',
              month:   r['МЕСЯЦ'] || r['Месяц'] || r['MONTH'] || '',
              year:    r['ГОД']   || r['Год']   || r['YEAR']  || '',
              sum:     r['СУММА, РУБ'] || r['СУММА'] || r['SUM'] || 0
            };
          });
        }
      },
      columns: [
        { data: 'mo_code', title: 'МО (КОД)' },
        { data: 'mo_name', title: 'МО (НАИМЕН.)' },
        { data: 'month',   title: 'Месяц' },
        { data: 'year',    title: 'Год' },
        { data: 'sum',     title: 'Сумма, руб', render: $.fn.dataTable.render.number(' ', ',', 2) }
      ],
      dom: 'Bfrtip',
      buttons: [
        { extend: 'csvHtml5',   title: 'lpu_month_sum' },
        { extend: 'excelHtml5', title: 'lpu_month_sum' }
      ],
      columnDefs: [{ defaultContent: '', targets: '_all' }],
      processing: true, deferRender: true
    });

    var dt2 = $('#tbl2').DataTable({
  ajax: {
    url: '/api/report.php',
    data: function (d) {
      d.type  = 'lpu_tpayment';
      d.year  = $('#y2').val();
      d.month = String($('#m2').val()).padStart(2, '0'); 
    },
    dataSrc: function (json) {
      if ((json.data||[])[0]) console.log(Object.keys(json.data[0]));
      return (json.data || []).map(function (r) {
        return {
          mo_code: r['МЕД. ОРГАНИЗАЦИЯ (КОД)'] ||
                   r['МО (КОД)'] || r['MO_CODE'] || '',
          mo_name: r['МЕД. ОРГАНИЗАЦИЯ (НАИМЕНОВАНИЕ)'] ||
                   r['МО (НАИМЕНОВАНИЕ)'] || r['МО (НАИМЕН.)'] || r['MO_NAME'] || '',
          pay_type_code: r['ТИП ОПЛАТЫ (КОД)'] || '',
          pay_type_name: r['ТИП ОПЛАТЫ (НАИМЕНОВАНИЕ)'] || '',
          bills_count: r['КОЛИЧЕСТВО СЧЕТОВ'] || 0,
          sum: r['СУММА'] || r['СУММА, РУБ'] || 0
        };
      });
    }
  },
  columns: [
    { data: 'mo_code',       title: 'МО (КОД)' },
    { data: 'mo_name',       title: 'МО (НАИМЕН.)' },
    { data: 'pay_type_code', title: 'Тип оплаты (код)' },
    { data: 'pay_type_name', title: 'Тип оплаты (наим.)' },
    { data: 'bills_count',   title: 'Кол-во счетов', render: $.fn.dataTable.render.number(' ', ',', 0) },
    { data: 'sum',           title: 'Сумма',         render: $.fn.dataTable.render.number(' ', ',', 2) }
  ],
  dom: 'Bfrtip',
  buttons: [
    { extend: 'csvHtml5',   title: 'lpu_tpayment' },
    { extend: 'excelHtml5', title: 'lpu_tpayment' }
  ],
  columnDefs: [{ defaultContent: '', targets: '_all' }],
  language: { emptyTable: 'Нет данных за выбранный период' }
});

$('#load2').on('click', function(){ dt2.ajax.reload(); });

    $('#load2').on('click', function(){ dt2.ajax.reload(); });

    var dt3 = $('#tbl3').DataTable({
      ajax: { url: '/api/report.php', dataSrc: 'data', data: function(d){
        d.type='helpform_volumes'; d.year=$('#y3').val(); d.month=$('#m3').val();
      }},
      columns: [
        { data: 'ВИД ПОМОЩИ (КОД)',          title: 'Вид помощи (код)' },
        { data: 'ВИД ПОМОЩИ (НАИМЕНОВАНИЕ)', title: 'Вид помощи (наим.)' },
        { data: 'КОЛИЧЕСТВО ПОСЕЩЕНИЙ',      title: 'Кол-во посещений', render: $.fn.dataTable.render.number(' ', ',', 0) },
        { data: 'КОЛИЧЕСТВО ОБРАЩЕНИЙ',      title: 'Кол-во обращений', render: $.fn.dataTable.render.number(' ', ',', 0) },
        { data: 'КОЛИЧЕСТВО СЧЕТОВ',         title: 'Кол-во счетов',    render: $.fn.dataTable.render.number(' ', ',', 0) },
        { data: 'СУММА',                     title: 'Сумма',            render: $.fn.dataTable.render.number(' ', ',', 2) }
      ],
      dom: 'Bfrtip',
      buttons: [
        { extend: 'csvHtml5',  title: 'helpform_volumes' },
        { extend: 'excelHtml5',title: 'helpform_volumes' }
      ]
    });
    $('#load3').on('click', function(){ dt3.ajax.reload(); });
  </script>
</body>
</html>
